---
title: Influence of School Closure on COVID-19 Contaminations in Ireland and Repercussions across Age Groups
author:
  - name: Edgar Morgenroth
    email: edgar.morgenroth@dcu.ie
    affiliation: Dublin City University
    footnote: 1
  - name: Damien Dupr√©
    email: damien.dupre@dcu.ie
    affiliation: Dublin City University
    footnote: 2
address:
  - code: Dublin City University
    address: 	Glasnevin, Dublin 9, Ireland
footnote:
  - code: 1
    text: "Corresponding Author"
  - code: 2
    text: "Equal contribution"
abstract: |
  TBD

journal: "TBD"
date: "`r Sys.Date()`"

csl: ["csl/elsevier-harvard.csl"]
bibliography: ["bib/reference_list.bib"]

#linenumbers: true
#numbersections: true

header-includes:
  - \usepackage{booktabs}
  - \usepackage{float}

output:
  bookdown::pdf_book:
    base_format: rticles::elsevier_article
    keep_tex: false
  bookdown::word_document2:
    default
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = here::here("output"),
      output_file = c(glue::glue("{xfun::sans_ext(input)}.pdf"), glue::glue("{xfun::sans_ext(input)}.docx")), 
      output_format = "all",
      envir = globalenv()
    )
  })
---

(ref:overall) Evolution of confirmed Covid-19 cases in Ireland alongside with school closures.
(ref:descriptive) Evolution of confirmed Covid-19 cases by age groups in Ireland: raw data (bars) and 7 day rolling average (lines).
(ref:gam) Standardized effect of the smooth term in Generalized Additive Model by age group.
(ref:te) Matrix of Transfer Entropy coefficient and their corresponding p-value according every age group combination. Age groups on the x-axis are influencing the age groups on the y-axis ($X \rightarrow Y$). * $p < .05$, ** $p < .01$, *** $p < .001$.

```{r setup, include = FALSE}
# libraries --------------------------------------------------------------------
library(gratia)
library(here)
library(janitor)
library(knitr)
library(mgcv)
library(RTransferEntropy)
library(tidyverse)
library(zoo)

# options ----------------------------------------------------------------------
set.seed(123) # Seed for random number generation
options(scipen = 999) # disable sci number format
opts_chunk$set(
  cache.extra = rand_seed, 
  cache = TRUE,
  message = FALSE, 
  warning = FALSE, 
  error = FALSE,
  echo = FALSE, 
  fig.retina = 3
  )

# variables --------------------------------------------------------------------
age_order <- c("aged1to4", "aged5to14", "aged15to24", "aged25to34", "aged35to44", "aged45to54", "aged55to64", "aged65to74", "aged75to84", "aged85up")
age_name  <- c("1 to 4",   "5 to 14",   "15 to 24",   "25 to 34",   "35 to 44",   "45 to 54",   "55 to 64",   "65 to 74",   "75 to 84",   "85 and up")
age_color <- c("#999999",  "#E69F00",   "#56B4E9",    "#009E73",    "#F0E442",    "#0072B2",    "#D55E00",    "#CC79A7",    "#000000",    "#CAB2D6")

# data -------------------------------------------------------------------------
df <- 
  read_csv(
    here("data/age_groups.csv"), 
    col_types = list(
      .default = col_double(), 
      Date = col_date(format = "%d/%m/%Y")
    )
  ) |> 
  clean_names() |> 
  rename(total_cases = total) |> 
  arrange(date) |> 
  mutate(
    timeline = date - lag(date),  # check if gap between dates
    total_changes = total_cases - lag(total_cases)
  )

df_long <- df |> 
  select(c(date, starts_with("aged"))) |> 
  pivot_longer(-date, names_to = "age_group", values_to = "covid_cases") |> 
  mutate(age_group = factor(age_group, levels = age_order)) |> 
  group_by(age_group) |> 
  mutate(
    covid_cases_7davg = rollmean(covid_cases, k = 7, fill = NA),
    covid_changes = covid_cases - lag(covid_cases),
    covid_changes_7davg = rollmean(covid_changes, k = 7, fill = NA)
  ) |> 
  ungroup()

df_wide_changes <- df_long |> 
  select(date, age_group, covid_changes) |> 
  pivot_wider(names_from = age_group, values_from = covid_changes) |> 
  drop_na()

df_school <- df |> 
  select(date, schools_closed) |> 
  mutate(schools_closure_day = schools_closed - lag(schools_closed)) |> 
  filter(schools_closure_day == 1) |> 
  rowid_to_column("schools_closure_wave") |> 
  full_join(df, by = c("date", "schools_closed")) |> 
  arrange(date) |> 
  fill(schools_closure_wave, .direction = "down") |> 
  mutate(schools_closure_wave = replace_na(schools_closure_wave, 0)) |> 
  group_by(schools_closure_wave) |> 
  mutate(schools_time_since_closure = row_number()) |> 
  ungroup()

df_school |>
  filter(schools_closed == 1) |>
  count(schools_closure_wave) |>
  rename(schools_closure_wave_n = n)

df_school_long <- df_school |> 
  filter(schools_closed == 1) |> 
  count(schools_closure_wave) |> 
  rename(schools_closure_wave_n = n) |> 
  right_join(df_school, by = "schools_closure_wave") |> 
  filter(schools_closure_wave_n > 20 & schools_time_since_closure < 40) |> # keep only closure waves longer than 20 days but display only the first 39 days
  pivot_longer(c("aged1to4", "aged5to14", "aged15to24"), names_to = "age_group", values_to = "covid_cases") |> 
  mutate(
    schools_closure_wave = factor(schools_closure_wave),
    age_group = factor(age_group, levels = c("aged1to4", "aged5to14", "aged15to24"))
  ) |> 
  group_by(age_group) |> 
  mutate(
    covid_changes = covid_cases - lag(covid_cases),
    covid_cases_7davg = rollmean(covid_cases, k = 7, fill = NA),
    covid_changes_7davg = rollmean(covid_changes, k = 7, fill = NA)
  ) |> 
  ungroup()

df_school_long |>
  filter(schools_closure_day == 1 & age_group == "aged1to4") |>
  select(date, schools_closure_wave, schools_closure_wave_n)
```

```{r analyses, cache=TRUE}
source(here("analysis/gam_analysis.R"))
source(here("analysis/te_analysis.R"))
```

Introduction
==========================

Since the onset of Covid-19, contradicting messages are circulating about the spread of the virus in schools. Sometimes presented as a safe environment [@falk2021covid; @walger2020children], at other times designed as an aggravating factor of the pandemic [@lopez2020transmission; @meuris2021transmission], child care facilities and schools have been closed multiple times in most countries to protect the public health. However, the efficacy of school closure is still unknown and little is know about how Covid-19 Cases spread across age cohort and especially from the younger cohort being at school to older cohorts including parents, grand parents and relatives. Some evidence show that school is an influential environment where the virus is likely to spread. Once contaminated at school, a common spread believe is that the children and teenagers will then contaminate their parents. Therefore, among the political actions to stop the spread of Covid-19, the closure of primary and secondary schools was widely adopted worldwide. This research aims to investigate 1) the effect of school closure on the evolution of Covid-19 cases and 2) the temporal relationship between the rise of cases in children and teenagers with the rise of cases of older age group.

## Influence of School Closure

One of the strongest assumption of government actions is that by reducing social contact will reduce the spread of the virus. Therefore, it is legitimate to believe that by closing schools, a reduction of the contaminations would be observed in the younger age groups. However, the efficiency of school closure on the reduction of Covid-19 cases is still questioned. While some research have observed that school closures contribute to limit or to reduce the growth rate of confirmed cases after implementation [@yoshiyuki2020effects; @stage2021shut], other did not observe a change in the evolution of Covid-19 cases [@iwata2020school; @chang2020modelling]. For instance, a controlled comparison between similar localities in Japan with schools closed and school open did not revealed any evidence that school closures reduced the spread of Covid-19 [@fukumoto2021no]. If the school closure had a real impact on the evolution of confirmed Covid-19 cases, it should be possible to observe a decrease or a least an inflection in the trend of its evolution among younger age groups.

## Causal Relationship Between Age Groups

A second implicit believe regarding the effect of school closure on the spread of Covid-19 is that school not only has an effect on to the spread of the virus in children and teenagers but also has a knock-on effect on the spread of the virus in older age groups also called Secondary Attack Rate (SAR). The contaminated children and teenagers would bring the virus back at home and, then, they will contaminate their parents and relatives. For example, a research investigating the contamination in the household network not only revealed an exceptional high rate of secondary contamination but also that these contamination happened when the school were closed [@sorianoarandes2021household]. 

Despite being reported in several clinical and epidemiological studies [@zhendong2020clinical; @siebach2021childhood], multiple research have shown that the SAR from children to household members was, in fact, lower than expected [@kim2021role; @ludvigsson2020children; @vanderhoek2020role; @heavey2020evidence]. However, the SAR of children and teenagers to the household member is likely to be age-dependent, with difference between infants, primary and secondary school children, and college students [@grasleguen2021reopening]. If a secondary transmission from children and teenagers to household member has a significant influence, then a temporal causality relationship between their evolution should be observed.

Method
============

## Observations

The data were collected from the official daily publication of Covid-19 cases by the Irish Department of Health. They include the amount of daily cases for 10 age groups from `r format(min(df$date), "%B %d, %Y")` to `r format(max(df$date), "%B %d, %Y")`. For each day during this period, school closure either due to a government decision or a public holiday is determined.

## Data Analysis

### Generalised Additive Model

Four periods of school closure longer that 14 days have been identified. These four periods are used to fit a Generalised Additive Model (or GAM) using the R package *mgcv* [@wood2017generalized] in order to test the hypothesis of a significant change in the evolution of cases among age groups from 1 to 4, from 5 to 14, and from 15 to 24 (Eq 1).

By estimating the degree of smoothness of a Bayesian spline smoothing using restricted maximum likelihood estimation [@wood2011fast], GAM identifies dynamic patterns underlying the evolution of Covid-19 cases reported while taking into account the random effect of different age groups as follows:

\begin{align}
Y_{is} = \alpha_{i} + f(X_{s}) + a_{is} + \epsilon_{is}
\end{align}

\noindent where $i$ is an age group among the 10 age groups investigated and $s$ is the date corresponding to the confirmed Covid-19 cases. $Y_{is}$ represents the confirmed Covid-19 cases assuming a negative binomial distribution for the fitting [@loader2006local]. The response variable $Y_{is}$ includes a specific intercept for each age group ($\alpha_{i}$). A smooth effect over time $f(X_{s})$ is applied to model (Eq 2) to predict the nonlinear evolution of Covid-19 cases. This smooth effect $f(X_{s})$ is built up in basic components, called the basis functions $b_{j}(X_{s})$, such that:

\begin{align}
f(X_{s})=\sum_{j=1}^{k}\beta_{j}\times b_{j}(X_{s})
\end{align}

\noindent where the regression parameters $\beta_{j}$ are estimated by penalized likelihood maximization.

The model also includes the random effects term $a_{is}= Zb_{i}$ where $Z$ is a random effects matrix and $b_{i}$ is a vector of random effects described by $b_{i} \sim N(0, D)$. In this, $D$ represents a covariance matrix. The error term $\epsilon_{is}$ is assumed to be normally and independently distributed $\epsilon_{is} \sim N(0, \sigma^2)$.

### Transfer Entropy 

Transfer Entropy (TE) can be used to infer the temporal relationship between two time series $I$ and $J$. This measure indicates whether $J$ can be used to to reduce the uncertainty on the future of $I$ and, consequently, that $J$ causes $I$ [@schreiber2000measuring]. As such, Granger causality is a special case of TE applied to times series that are jointly Gaussian distributed [@barnett2009granger]. Therefore, TE is a more robust analysis of times series especially when applied to the impact of age cohort in pandemic transmission [@kissler2020symbolic].

The influence of the evolution in Covid-19 cases across all age groups is evaluated using Shannon's transfer entropy is given by:
  
\begin{align}
  T_{X \rightarrow Y}(k,l) = \sum_{x,y} p\left(x_{t+1}, x_t^{(k)}, y_t^{(l)}\right) \cdot log \left(\frac{p\left(x_{t+1}| x_t^{(k)}, y_t^{(l)}\right)}{p\left(x_{t+1}|x_t^{(k)}\right)}\right),
\end{align}

\noindent where $T_{X\rightarrow Y}$ consequently measures the influence of the change dynamic from an age group $X$ to another age group $Y$ (Eq 3). 

In order to observe how increase in daily numbers reported from a specific age group affects the other age groups, the day-by-day difference in Covid-19 confirmed cases (i.e., differences with a lag 1) is calculated. The use of day-by-day difference in Covid-19 confirmed cases satisfies the requirement of stationary for the calculation of Shannon's Transfer Entropy [@shannon1948mathematical]. The Transfer Entropy analysis of younger age groups daily changes in Covid-19 cases on older age groups is done using the R package *RTransferEntropy* [@behrendt2019rtransferentropy].

Results
===================

Overall, the trend of confirmed Covid-19 cases in Ireland is similar to those of other European countries (Figure \@ref(fig:overall)). Indeed it is possible to observe a significant increase corresponding to each of the 4 waves of transmission (March-April 2020, December 2020-January 2021, September-October 2021 and November-December 2021). 

```{r overall, fig.width=4.5, fig.height=3, fig.cap="(ref:overall)", fig.pos = "!h"}
overall_plot <- df |> 
  ggplot(aes(date, total_cases)) +
  geom_tile(aes(fill = factor(schools_closed), height = Inf), na.rm = TRUE, alpha = .4) +
  geom_line(na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %y") +
  scale_fill_manual(labels = c("Open", "Closed", "Na"), values = c("light blue", "red", "orange")) +
  labs(
    x = "Date", 
    y = "Covid-19 Cases in Ireland",
    fill = "Schools"
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    text = element_text(size = 10, family = "serif"),
    axis.text = element_text(size = 10),
    panel.background = element_rect(colour = "black", size = 0.1)
  )

overall_plot
```

The evolution of Covid-19 cases reveals some similarities across all age groups. However, the influence of each waves on the each groups has also some particularities (Figure \@ref(fig:descriptive)). For example, the first wave was more important among the oldest age groups whereas the third wave was more important among the youngest age groups.

```{r descriptive, fig.width=4.5, fig.height=7, fig.cap="(ref:descriptive)"}
descriptive_plot <- df_long |> 
  ggplot() +
  geom_col(aes(date, covid_cases), na.rm = TRUE) +
  geom_line(aes(date, covid_cases_7davg, color = age_group), na.rm = TRUE) +
  scale_x_date("Date", date_breaks = "3 months", date_labels = "%b %y") +
  scale_y_continuous("Confirmed Covid-19 Cases in Ireland") +
  scale_color_manual(labels = age_name, values = age_color) +
  facet_grid(
    age_group ~ ., 
    scales = "free",
    labeller = as_labeller(
      c(
        aged1to4 = "1 to 4",
        aged5to14 = "5 to 14",
        aged15to24 = "15 to 24", 
        aged25to34 = "25 to 34", 
        aged35to44 = "35 to 44", 
        aged45to54 = "45 to 54", 
        aged55to64 = "55 to 64", 
        aged65to74 = "65 to 74", 
        aged75to84 = "75 to 84", 
        aged85up = "85 and up"
        )
      )
  ) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.placement = "outside",
    text = element_text(size = 10, family = "serif"),
    axis.text = element_text(size = 10),
    panel.background = element_rect(colour = "black", size = 0.1)
  )

descriptive_plot
```

In order to evaluate the shape of the trend in the numbers of Covid-19 cases reported after the three school closure longer than 14 consecutive days, a GAM was fitted taking into account numbers for 1 to 4, 5 to 14, and 15 to 24 year old. The obtained results satisfy the requirements to fit this model which explains `r scales::percent(gam_summary$dev.expl, accuracy = 0.1)` of the deviance in Covid-19 cases. These results show no significant change in the evolution of cases for 1 to 4 year old (`r gam_results["s(date):1to4"]`) as well as for 5 to 14 year old (`r gam_results["s(date):5to14"]`). However, the smooth term of the GAM is significant for 15 to 24 year old (`r gam_results["s(date):15to24"]`), which indicates that the evolution of cases is not linear and, therefore, the school closure had a significant impact on the evolution of cases (Figure \@ref(fig:gam)).

```{r gam, fig.width=4.5, fig.height=3, fig.cap="(ref:gam)"}
gam_plot
```

Before the Transfer Entropy analysis, an Augmented Dickey-Fuller has been applied on each age group in order to insure that the daily changes in Covid-19 cases are stationary. 

```{r}
# adf_res <- df_long |> 
#   group_by(age_group) |> 
#   summarise(
#     aTSA::adf.test(covid_changes, output = FALSE) |> 
#       map_df(as_tibble)
#   )
```

```{r te, fig.width=4.5, fig.height=4.5, fig.cap="(ref:te)"}
te_plot
```

The results of the Transfer Entropy calculations between age groups are reported Figure \@ref(fig:te). The first observation is the absence of symmetry between influencing age groups (i.e., $X$) and influenced age groups (i.e., $Y$). Indeed, the change in Covid-19 cases in some age groups are influenced by other age groups but they are not reciprocally influencing these age groups. This is the case of 15 to 24 years old who appears to be contaminated by all age groups until 84 but there is no significant support that they are contaminating groups older than 34 which should include their parents and relatives.

Discussion & Conclusion
===================

Knowledge about the transmission of the virus significantly improved with the amount of studies performed, especially in the case of how the virus behaves with children. From the early analyses showing that the virus was instantness in children [@li2020role], the results has changed to more nuanced position which states that the spread of the virus in children is moderate.

This indicate mix results, while the school closure was ineffective in child care settings and primary school, the closure of secondary schools and colleges had an impact on Covid-19 transmission. This impact is probably responsible for the absence of reciprocity in the transmission of 15 to 24 age group. By drastically reducing their social contacts in secondary schools and colleges, this cohort has more been the target of Covid-19 contaminations rather than the vector of Covid-19.

References {#references .unnumbered}
==========
